name: PR Checks

on:
  pull_request:
    branches: [dev]
    paths:
      - 'articles/**'
      - 'categoryIcons/**'
      - 'category-article-mapping.yml'

jobs:
  validate-structure:
    name: Validate Repo Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate structure
        run: node scripts/validate-structure.mjs

  validate-images:
    name: Validate Image References
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get changed article.md files
        id: changed
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          FILES=$(gh pr diff "$PR_NUMBER" --name-only | grep 'articles/.*/article\.md$' || true)
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "Changed articles: $FILES"

      - name: Validate image references
        if: steps.changed.outputs.files != ''
        env:
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
        run: node scripts/validate-images.mjs $CHANGED_FILES

      - name: Validate all images (if mapping changed)
        if: steps.changed.outputs.files == ''
        run: node scripts/validate-images.mjs

  render-preview:
    name: Render Article Preview
    runs-on: ubuntu-latest
    needs: [validate-structure, validate-images]
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout content repo (PR)
        uses: actions/checkout@v4
        with:
          path: content
          fetch-depth: 0

      - name: Checkout main app
        uses: actions/checkout@v4
        with:
          repository: klimofey/analoghub-main-nextjs
          token: ${{ secrets.MAIN_REPO_PAT }}
          path: app

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup content in app
        run: |
          rm -rf app/content
          cp -r content app/content

      - name: Install dependencies
        working-directory: app
        run: npm install --legacy-peer-deps

      - name: Build content
        working-directory: app
        run: npx tsx scripts/build-content.ts

      - name: Build app
        working-directory: app
        run: npm run build
        env:
          NEXT_PUBLIC_DEV_ENV: 'true'

      - name: Install Playwright
        working-directory: app
        run: npx playwright install chromium

      - name: Start server and render PDFs
        working-directory: app
        run: |
          npm start &
          sleep 5

          # Find changed article slugs (new structure: articles/{slug}/article.md)
          CHANGED=$(cd ../content && git diff --name-only origin/dev...HEAD -- 'articles/*/article.md' || true)

          mkdir -p /tmp/previews

          for FILE in $CHANGED; do
            SLUG=$(echo "$FILE" | cut -d'/' -f2)

            # Look up category for this slug from the mapping YAML
            CATEGORY=$(grep -B 20 "slug: ${SLUG}$" ../content/category-article-mapping.yml | grep '    slug:' | tail -1 | sed 's/.*slug: //')

            if [ -z "$CATEGORY" ]; then
              echo "Warning: Could not find category for slug $SLUG"
              continue
            fi

            URL="http://localhost:3000/category/${CATEGORY}/article/${SLUG}"
            echo "Rendering: $URL"
            npx playwright pdf "$URL" "/tmp/previews/${CATEGORY}_${SLUG}.pdf" --wait-for-timeout 3000 || true
          done

          kill %1 || true

      - name: Upload preview artifacts
        uses: actions/upload-artifact@v4
        with:
          name: article-previews
          path: /tmp/previews/
          if-no-files-found: ignore

      - name: Comment on PR with preview links
        if: always()
        env:
          RUN_ID: ${{ github.run_id }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let files = [];
            try {
              files = fs.readdirSync('/tmp/previews').filter(f => f.endsWith('.pdf'));
            } catch { }

            if (files.length === 0) return;

            const body = [
              '## Article Preview',
              '',
              `Rendered ${files.length} article(s) as PDF. Download from the [workflow artifacts](${process.env.REPO_URL}/actions/runs/${process.env.RUN_ID}).`,
              '',
              '| Article | Status |',
              '|---------|--------|',
              ...files.map(f => `| ${f.replace('.pdf', '')} | Rendered |`),
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body,
            });
