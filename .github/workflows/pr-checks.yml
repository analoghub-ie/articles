name: PR Checks

on:
  pull_request:
    branches: [main]
    paths:
      - 'articles/**'
      - 'images/**'

jobs:
  validate-article:
    name: Validate Article Frontmatter
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get changed .md files
        id: changed
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          FILES=$(gh pr diff "$PR_NUMBER" --name-only | grep '\.md$' || true)
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "Changed markdown files: $FILES"

      - name: Validate articles
        if: steps.changed.outputs.files != ''
        env:
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
        run: node scripts/validate-article.mjs $CHANGED_FILES

  validate-images:
    name: Validate Image References
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get changed .md files
        id: changed
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GH_TOKEN: ${{ github.token }}
        run: |
          FILES=$(gh pr diff "$PR_NUMBER" --name-only | grep '\.md$' || true)
          echo "files<<EOF" >> "$GITHUB_OUTPUT"
          echo "$FILES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Validate image references
        if: steps.changed.outputs.files != ''
        env:
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
        run: node scripts/validate-images.mjs $CHANGED_FILES

  render-preview:
    name: Render Article Preview
    runs-on: ubuntu-latest
    needs: [validate-article, validate-images]
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout content repo (PR)
        uses: actions/checkout@v4
        with:
          path: content
          fetch-depth: 0

      - name: Checkout main app
        uses: actions/checkout@v4
        with:
          repository: klimofey/analoghub-main-nextjs
          token: ${{ secrets.MAIN_REPO_PAT }}
          path: app

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup content in app
        run: |
          rm -rf app/content
          cp -r content app/content

      - name: Install dependencies
        working-directory: app
        run: npm install --legacy-peer-deps

      - name: Build content
        working-directory: app
        run: npx tsx scripts/build-content.ts

      - name: Build app
        working-directory: app
        run: npm run build
        env:
          NEXT_PUBLIC_DEV_ENV: 'true'

      - name: Install Playwright
        working-directory: app
        run: npx playwright install chromium

      - name: Start server and render PDFs
        working-directory: app
        run: |
          npm start &
          sleep 5

          CHANGED=$(cd ../content && git diff --name-only origin/main...HEAD -- 'articles/**/*.md' || true)

          mkdir -p /tmp/previews

          for FILE in $CHANGED; do
            CATEGORY=$(echo "$FILE" | cut -d'/' -f2)
            ARTICLE=$(basename "$FILE" .md)
            URL="http://localhost:3000/category/${CATEGORY}/article/${ARTICLE}"

            echo "Rendering: $URL"
            npx playwright pdf "$URL" "/tmp/previews/${CATEGORY}_${ARTICLE}.pdf" --wait-for-timeout 3000 || true
          done

          kill %1 || true

      - name: Upload preview artifacts
        uses: actions/upload-artifact@v4
        with:
          name: article-previews
          path: /tmp/previews/
          if-no-files-found: ignore

      - name: Comment on PR with preview links
        if: always()
        env:
          RUN_ID: ${{ github.run_id }}
          REPO_URL: ${{ github.server_url }}/${{ github.repository }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let files = [];
            try {
              files = fs.readdirSync('/tmp/previews').filter(f => f.endsWith('.pdf'));
            } catch { }

            if (files.length === 0) return;

            const body = [
              '## Article Preview',
              '',
              `Rendered ${files.length} article(s) as PDF. Download from the [workflow artifacts](${process.env.REPO_URL}/actions/runs/${process.env.RUN_ID}).`,
              '',
              '| Article | Status |',
              '|---------|--------|',
              ...files.map(f => `| ${f.replace('.pdf', '')} | Rendered |`),
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body,
            });
